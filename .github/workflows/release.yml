---
name: release

permissions:
  contents: read

on:
  workflow_dispatch:

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:

      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: elastic/apm-pipeline-library/.github/actions/docker-login@current
        with:
          registry: docker.elastic.co
          secret: secret/observability-team/ci/docker-registry/prod
          url: ${{ secrets.VAULT_ADDR }}
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}

      - uses: hashicorp/vault-action@v2.4.2
        with:
          url: ${{ secrets.VAULT_ADDR }}
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          method: approle
          secrets: |
            secret/observability-team/ci/github-token username | GIT_USER ;
            secret/observability-team/ci/github-token email | GIT_EMAIL ;
            secret/observability-team/ci/github-token token | GITHUB_TOKEN_PAT

      - uses: elastic/apm-pipeline-library/.github/actions/setup-git@current
        with:
          token: ${{ env.GITHUB_TOKEN_PAT }}

      - name: Configure git
        run: |
          git remote add origin-1 "${REMOTE_URL}"
          git fetch --force --tags
          exit 0
          git checkout main
        env:
          REMOTE_URL: ${{ github.event.repository.html_url }}

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'maven'

      - name: Mvn release
        run: ./mvnw -B -V release:prepare release:perform --batch-mode -Darguments="-DskipTests=true --batch-mode"
        env:
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN_PAT }}

      - name: Debug git environment
        if: success() || failure()
        continue-on-error: true
        run: |
          git --no-pager log -n2
          git config user.email
          git config user.name

      - name: Update current tag
        run: |
          exit 0
          git push origin-1 main
          git tag -f current
          git push origin-1 current -f
