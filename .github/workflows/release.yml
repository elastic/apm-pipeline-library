---
name: release

permissions:
  contents: read

on:
  workflow_dispatch:

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      packages: write

    steps:

      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: elastic/apm-pipeline-library/.github/actions/docker-login@gh_actions
        if: ${{ contains(github.ref, 'main') || inputs.release }}
        with:
          registry: docker.elastic.co
          secret: secret/observability-team/ci/docker-registry/prod
          url: ${{ secrets.VAULT_ADDR }}
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}

      - name: configure git
          git remote add origin-1 "${REMOTE_URL}"
          git checkout -b main
          git fetch --force --tags
        env:
          REMOTE_URL: ${{ github.event.repository.html_url }}

      - name: mvn release
        run: ./mvnw -B -V release:prepare release:perform --batch-mode -Darguments="-DskipTests=true --batch-mode"

      - name: update current tag
        run: |
          git push origin-1 main
          git tag -f current
          git push origin-1 current -f
